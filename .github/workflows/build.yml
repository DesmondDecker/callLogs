name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        # First install base dependencies and fix any broken packages
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          wget \
          curl \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          autotools-dev \
          autoconf-archive \
          pkg-config \
          gettext \
          m4 \
          zlib1g-dev \
          libssl-dev \
          libffi-dev \
          libsqlite3-dev \
          libbz2-dev \
          libreadline-dev \
          libncurses5-dev \
          libncursesw5-dev \
          xz-utils \
          tk-dev \
          libxml2-dev \
          libxmlsec1-dev \
          liblzma-dev \
          ccache \
          zip \
          openjdk-17-jdk
        
        # Fix any broken installations
        sudo apt-get install -f -y
        
        # Install media dependencies with proper order
        sudo apt-get install -y \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev
        
        # Install GStreamer dependencies in correct order
        sudo apt-get install -y \
          libunwind-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev
        
    - name: Setup Android SDK
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # Create SDK directory structure
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
        
        # Download and extract command-line tools (latest version compatible with Java 17)
        cd "$ANDROID_SDK_ROOT/cmdline-tools"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip
        mv cmdline-tools latest
        rm cmdline-tools.zip
        
        # Add to PATH
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/build-tools/34.0.0" >> $GITHUB_PATH
        
    - name: Install Android SDK components
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        
        # Verify Java version for SDK manager
        echo "Java version for SDK manager:"
        java -version
        
        # Accept licenses first
        yes | $SDKMANAGER --licenses > /dev/null 2>&1 || true
        
        # Install components with updated versions
        $SDKMANAGER "build-tools;34.0.0"
        $SDKMANAGER "platforms;android-34"
        $SDKMANAGER "platform-tools"
        $SDKMANAGER "cmake;3.22.1"
        $SDKMANAGER "ndk;25.2.9519653"
        
        # Set NDK environment
        export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Cache Buildozer directories
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-v5
        restore-keys: |
          ${{ runner.os }}-buildozer-v5-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install -r requirements.txt
        
    - name: Create buildozer.spec
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "Creating buildozer.spec..."
          cat > buildozer.spec << 'EOF'
        [app]
        title = Kortahun United
        package.name = kortahununited
        package.domain = com.kortahununited
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas,json
        source.exclude_dirs = tests, bin, .git, .github, __pycache__, .pytest_cache, .buildozer, .vscode, .idea, node_modules
        version = 1.0.5
        requirements = python3,kivy==2.1.0,kivymd==1.1.1,requests==2.31.0,urllib3==2.0.7,pyjnius,android
        orientation = portrait
        fullscreen = 0
        android.permissions = INTERNET,ACCESS_NETWORK_STATE,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,READ_CALL_LOG,READ_PHONE_STATE,READ_CONTACTS
        android.logcat_filters = *:S python:D
        android.archs = arm64-v8a, armeabi-v7a
        android.allow_backup = True
        android.api = 34
        android.minapi = 21
        android.ndk = 25b
        android.ndk_api = 21
        android.accept_sdk_license = True
        android.private_storage = True
        android.numeric_version = 105
        p4a.bootstrap = sdl2
        p4a.setup_py = false
        
        [buildozer]
        log_level = 2
        warn_on_root = 1
        EOF
        fi
        
        echo "âœ… buildozer.spec created/verified:"
        head -20 buildozer.spec
        
    - name: Setup build environment
      run: |
        # Set environment variables with Java 17
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653
        export NDK_HOME=$ANDROID_NDK_ROOT
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export JDK_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/build-tools/34.0.0:$PATH
        
        # Persist to GitHub environment
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        echo "JDK_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
        # Build tool settings
        echo "USE_SDK_WRAPPER=1" >> $GITHUB_ENV
        echo "ANDROID_SDK_BUILD_TOOLS_VERSION=34.0.0" >> $GITHUB_ENV
        echo "ANDROIDAPI=34" >> $GITHUB_ENV
        echo "NDKAPI=21" >> $GITHUB_ENV
        
        # Verify installations
        echo "ðŸ” Verifying Android tools:"
        echo "Java version:"
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
        ls -la "$ANDROID_SDK_ROOT/build-tools/34.0.0/" || echo "âŒ build-tools not found"
        ls -la "$ANDROID_SDK_ROOT/platforms/android-34/" || echo "âŒ platform not found"
        ls -la "$ANDROID_NDK_ROOT/" || echo "âŒ NDK not found"
        
    - name: Initialize buildozer
      run: |
        # Initialize buildozer (this will create necessary directories)
        buildozer android clean || echo "Clean failed, continuing..."
        
        # Set up buildozer environment
        mkdir -p .buildozer/android/platform/
        
    - name: Build APK with Buildozer
      run: |
        echo "ðŸš€ Starting APK build..."
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        
        # Verify environment
        echo "Environment check:"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        echo "JAVA_HOME: $JAVA_HOME"
        echo "Java version: $(java -version 2>&1 | head -n 1)"
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer version)"
        
        # Set environment variables for build
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export JDK_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        
        # Build with increased verbosity and error handling
        set -e
        buildozer -v android debug 2>&1 | tee build.log || {
          echo "âŒ Build failed! Last 100 lines of build log:"
          tail -100 build.log
          echo "ðŸ“‹ Full build log saved as artifact"
          exit 1
        }
        
        # Verify APK was created
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… APK build successful!"
          ls -la bin/
          
          # Get APK info
          APK_FILE=$(ls bin/*.apk | head -1)
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "ðŸ“¦ APK: $APK_FILE (Size: $APK_SIZE)"
        else
          echo "âŒ No APK found in bin/ directory"
          echo "Contents of bin directory:"
          ls -la bin/ || echo "bin directory does not exist"
          exit 1
        fi
        
    - name: Upload build log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: build.log
        retention-days: 7
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kortahun-united-apk-${{ github.sha }}
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload APK to release
      if: github.event_name == 'release' && success()
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        name: "Kortahun United v${{ github.ref_name }}"
        body: |
          ## Kortahun United Android App
          
          **Version:** ${{ github.ref_name }}
          **Build:** ${{ github.sha }}
          **Built:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ### Features
          - Real Android call log tracking
          - Backend synchronization
          - QR code device registration
          - Automatic heartbeat monitoring
          
          ### Requirements
          - Android 5.0+ (API 21+)
          - Internet connection for sync
          - Call log permissions
          
          **Download the APK below and enable "Install from unknown sources" in your Android settings.**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸ“± Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Runner:** ubuntu-22.04" >> $GITHUB_STEP_SUMMARY
        echo "**Java:** 17" >> $GITHUB_STEP_SUMMARY
        echo "**Python:** 3.9" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f bin/*.apk ]; then
          APK_FILE=$(ls bin/*.apk | head -1)
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "**âœ… Build Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¦ APK:** $(basename "$APK_FILE")" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ’¾ Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
        else
          echo "**âŒ Build Status:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi