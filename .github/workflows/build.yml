name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}
    
    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
        pip3 install --upgrade pip
        pip3 install buildozer cython==0.29.33
    
    - name: Setup Android SDK and NDK
      run: |
        # Clean any existing Android setup to avoid conflicts
        rm -rf $HOME/.buildozer/android/platform/android-sdk
        rm -rf $HOME/.buildozer/android/platform/android-ndk*
        
        # Create directories
        mkdir -p $HOME/.buildozer/android/platform
        
        # Download and setup Android SDK
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/.buildozer/android/platform/android-sdk/cmdline-tools
        mv cmdline-tools $HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest
        
        # Create compatibility symlink for Buildozer
        mkdir -p $HOME/.buildozer/android/platform/android-sdk/tools/bin
        ln -s $HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager $HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
        ln -s $HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/avdmanager $HOME/.buildozer/android/platform/android-sdk/tools/bin/avdmanager
        
        # Download and setup Android NDK 25b (CRITICAL: Use NDK 25b, not older versions)
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        mv android-ndk-r25b $HOME/.buildozer/android/platform/android-ndk-r25b
        
        # Set environment variables - IMPORTANT: Point to the correct NDK version
        echo "ANDROIDSDK=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROIDNDK=$HOME/.buildozer/android/platform/android-ndk-r25b" >> $GITHUB_ENV
        echo "ANDROIDAPI=33" >> $GITHUB_ENV
        echo "ANDROIDMINAPI=21" >> $GITHUB_ENV
        
        # Verify the NDK path exists
        ls -la $HOME/.buildozer/android/platform/android-ndk-r25b
    
    - name: Build with Buildozer
      run: |
        buildozer android debug
      env:
        ANDROIDSDK: ${{ env.ANDROIDSDK }}
        ANDROIDNDK: ${{ env.ANDROIDNDK }}
        ANDROIDAPI: ${{ env.ANDROIDAPI }}
        ANDROIDMINAPI: ${{ env.ANDROIDMINAPI }}
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: call-log-monitor-apk
        path: bin/*.apk
        
    - name: List build directory contents (for debugging)
      if: failure()
      run: |
        echo "Build directory contents:"
        ls -la
        echo "Bin directory contents:"
        ls -la bin/ || echo "Bin directory not found"
        echo "Android platform contents:"
        ls -la $HOME/.buildozer/android/platform/ || echo "Platform directory not found"